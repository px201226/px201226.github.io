{"componentChunkName":"component---src-templates-post-jsx","path":"/Spring Cloud AWS Messaging Module Best Practice/","result":{"data":{"site":{"siteMetadata":{"title":"SOOLAB"}},"markdownRemark":{"id":"4329bf0c-4a54-5d63-9354-7dd221de8490","excerpt":"1. 개요 일반적으로 Spring 환경에서 Amazon SQS 라이브러리로  모듈을 사용합니다.  을 분석하고, 단점을 보완한 모듈을 설계하는 것을 목표로 합니다. 2. Spring Cloud AWS Messaging 모듈  모듈을 사용하면 를 추상화한 API를 사용해 쉽게 와 를 구현할 수 있습니다. 아래와 같이 간단한 설정만으로 Consumer의 경우…","html":"<h1><strong>1. 개요</strong></h1>\n<ul>\n<li>일반적으로 Spring 환경에서 Amazon SQS 라이브러리로 <code class=\"language-text\">spring-cloud-aws-messaging</code> 모듈을 사용합니다.</li>\n<li><code class=\"language-text\">spring-cloud-aws-messaging</code> 을 분석하고, 단점을 보완한 모듈을 설계하는 것을 목표로 합니다.</li>\n</ul>\n<!-- more -->\n<h1><strong>2. Spring Cloud AWS Messaging 모듈</strong></h1>\n<ul>\n<li><code class=\"language-text\">spring-cloud-aws-messaging</code> 모듈을 사용하면 <code class=\"language-text\">Amazon SQS SDK</code>를 추상화한 API를 사용해 쉽게 <code class=\"language-text\">Producer</code>와 <code class=\"language-text\">Consumer</code>를 구현할 수 있습니다.</li>\n<li>아래와 같이 간단한 설정만으로 Consumer의 경우 Polling Thread Pool을 자동으로 만들어주고, <code class=\"language-text\">@SqsListener</code> 어노테이션을 통해 특정 큐를 구독하여 메시지를 처리할 수 있습니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"># build<span class=\"token punctuation\">.</span>gradle\ndependencies <span class=\"token punctuation\">{</span>\n    implementation <span class=\"token string\">'org.springframework.cloud:spring-cloud-aws-autoconfigure:2.2.1.RELEASE'</span>\n    implementation <span class=\"token string\">'org.springframework.cloud:spring-cloud-aws-messaging:2.2.1.RELEASE'</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SqsConfig</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AWSCredentialsProvider</span> awsCredentialsProvider<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${cloud.aws.region.static}\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> region<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token annotation punctuation\">@Primary</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">AmazonSQSAsync</span> <span class=\"token function\">amazonSQSAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">AmazonSQSAsyncClientBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">standard</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">withCredentials</span><span class=\"token punctuation\">(</span>awsCredentialsProvider<span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">withRegion</span><span class=\"token punctuation\">(</span>region<span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">/**\n* Consumer 설정 클래스\n*/</span>\n<span class=\"token annotation punctuation\">@Configration</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SqsConsumeConfig</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AmazonSQSAsync</span> amazonSQSAsync<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n    *  Consumer 에서 SQS Queue로 폴링하는 컨테이너를 설정합니다.\n    **/</span>\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">SimpleMessageListenerContainerFactory</span> <span class=\"token function\">simpleMessageListenerContainerFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">final</span> <span class=\"token class-name\">SimpleMessageListenerContainerFactory</span> factory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SimpleMessageListenerContainerFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tfactory<span class=\"token punctuation\">.</span><span class=\"token function\">setAmazonSqs</span><span class=\"token punctuation\">(</span>amazonSQSAsync<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        factory<span class=\"token punctuation\">.</span><span class=\"token function\">setMaxNumberOfMessages</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        factory<span class=\"token punctuation\">.</span><span class=\"token function\">setWaitTimeOut</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        factory<span class=\"token punctuation\">.</span><span class=\"token function\">setBackOffTime</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span><span class=\"token number\">60000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> factory<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>SQS 큐를 Polling 하는 핵심 매커니즘을 <code class=\"language-text\">SimpleMessageListenerContainer</code>를 정의할 수 있습니다.</p>\n<ul>\n<li><strong>WaitTimeOut</strong> :- 현재 대기열에 메시지가 없는 경우 폴링 요청이 새 메시지가 도착할 때까지 기다리는 대기 시간 제한을 구성합니다. 값이 높을수록 시스템에 대한 폴링 요청이 크게 줄어듭니다.</li>\n<li><strong>MaxNumberOfMessage :</strong> Amazon SQS 시스템에 대한 한 번의 폴링 중에 검색해야 하는 최대 메시지 수를 구성합니다. 최대 메시지 수(1–10)</li>\n<li><strong>BackOffTime:-</strong> 폴링 스레드가 오류 발생 시 복구를 시도하기 전에 대기해야 하는 밀리초 수입니다. 이렇게 하면 작업자가 용량을 초과하는 요청에 압도당하는 것을 방지할 수 있습니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SqsMessageListener</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">/**\n    * 폴링 스레드에서 핸들링한 메시지가 @SqsListener 로 넘어옵니다.\n    **/</span>\n\t<span class=\"token annotation punctuation\">@SqsListener</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"QueueName\"</span><span class=\"token punctuation\">,</span> deletionPolicy <span class=\"token operator\">=</span> <span class=\"token class-name\">SqsMessageDeletionPolicy</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NEVER</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Payload</span> <span class=\"token class-name\">ApplicationEventMessage</span> message<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MessageHeaders</span> messageHeaders<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Acknowledgment</span> acknowledgment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" received Message from SQS queue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">/**\n* Producer 설정 클래스\n*/</span>\n<span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SqsPublishConfig</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AmazonSQSAsync</span> amazonSQSAsync<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ObjectMapper</span> objectMapper<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">QueueMessagingTemplate</span> <span class=\"token function\">queueMessagingTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">QueueMessagingTemplate</span><span class=\"token punctuation\">(</span>amazonSQSAsync<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">StringHttpMessageConverter</span> <span class=\"token function\">stringHttpMessageConverter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringHttpMessageConverter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FooService</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">QueueMessagingTemplate</span> queueMessagingTemplate<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">publih</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">queueMessageTemplate</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"queueName\"</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"1-SimpleMessageListenerContainer\" style=\"position:relative;\"><strong>1. SimpleMessageListenerContainer</strong><a href=\"#1-SimpleMessageListenerContainer\" aria-label=\"1 SimpleMessageListenerContainer permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li><code class=\"language-text\">spring-cloud-aws-messaging</code> 모듈을 사용하면 <code class=\"language-text\">SimpleMessageListenerContainer</code> 라는 클래스가 SQS 큐에서 메시지를 폴링하여 <code class=\"language-text\">@SqsHandler</code> 에게 넘깁니다.</li>\n<li><code class=\"language-text\">SimpleMessageListenerContainer</code> 는 Polling 을 위한 스레드풀을 별도로 생성하여 동작합니다.</li>\n<li>\n<p>Polling 스레드풀의 스레드 갯수는 아래 공식으로 결정됩니다.</p>\n<ul>\n<li>\n<p><strong>등록된 큐의 개수 * ( 폴링 시 한번에 받을 수 있는 최대 메시지 수 + 1)</strong></p>\n<ul>\n<li>ex) 등록된 큐의 개수가 1개이고, 폴링 시 한번에 받을 수 있는 최대 메시지 수가 10개이면 <code class=\"language-text\">1 * (10 + 1) = 11개</code>의 폴링 스레드가 생성됩니다.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/00da5f863fd101c9f3d5ff4268db761a/5d9a4/Untitled.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 58.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABzElEQVR42k1RCY7bMAz0Z7KJdZI6SEm2bMcpsvFm+//vlEmBbQeDwYiQ6SE1FFQNLpkocePSqNSU0kRun6CzW6vfmp/ZpRSMsUqN6gdaD0x56b1MvS7X0ua+7vO6L+tKGQFdQC9MYAICYPAgQFHnvbN2CJnbdqt9a8smSrXnOpV+pWnhvuXWLUa0l4guccnMmQu9TEHEwVobuOZ+xTIVihSR2ywp2ryknFuZa2oJiWMjZGFGdsaM40WCD9GNISDmgplDyhKSQXFtMoK0r20udSbiWueAwRoJ62V4/cYAVkkAB8FhELX+NY8xRv8HpdWLL4xifuqDDJ6k97KzLGy95XnFRMa+/iEqcNaL81Yu+rf/13fQxihtcibmSu9lhEQQs7SAkGTZGShBKqG+NNYAKFH+Nhgkv/faxPyPiWwmLU+SKdYWSgmlIRcgVvJgoIwzZ9mZfJy02py9t/697s91P5btq2+PqW8Aj1iO1ITPPP+m9VOOoR0Qp8tHPZ/DOA7fHx+7g0eZnrUfdTpK2zFu1glXY1dtrg42698V//bQtfml9dfpNNyUup1OD+efGA/nDw936970d+Pu2nx6vDt/d/DpQFTqN2UOrbfz+Q84JZFq9UYj4QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/static/00da5f863fd101c9f3d5ff4268db761a/ca1dc/Untitled.png' srcset='/static/00da5f863fd101c9f3d5ff4268db761a/e7570/Untitled.png 170w,\n/static/00da5f863fd101c9f3d5ff4268db761a/f46e7/Untitled.png 340w,\n/static/00da5f863fd101c9f3d5ff4268db761a/ca1dc/Untitled.png 680w,\n/static/00da5f863fd101c9f3d5ff4268db761a/02d09/Untitled.png 1020w,\n/static/00da5f863fd101c9f3d5ff4268db761a/9d567/Untitled.png 1360w,\n/static/00da5f863fd101c9f3d5ff4268db761a/5d9a4/Untitled.png 1626w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<h2 id=\"2-SimpleMessageListenerContainer-의-문제\" style=\"position:relative;\"><strong>2. SimpleMessageListenerContainer 의 문제</strong><a href=\"#2-SimpleMessageListenerContainer-%EC%9D%98-%EB%AC%B8%EC%A0%9C\" aria-label=\"2 SimpleMessageListenerContainer 의 문제 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/d7902636fe64116f866fd153d196fb07/78873/Untitled_1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 85.88235294117648%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsTAAALEwEAmpwYAAACLklEQVR42oWTiW6bQBCG/SyJYWfvA/bgMGAum8jkaPv+z9IlUdKYqir6hFYr/TvHP3MwmtQFchkoTjhnlBBG6b/YfQctaO9Q5WXTVqFutPVMKqAUKIng7UCBkA1KyU4MjFcEViknLmfKL5wPhLxDR0IHwCMmM2ORM8ac3MkPmPMOoDRZfWqmcR6Gq7Mhy5z1hQ2VyZ33oSzrPJQTwQEAGPsWmfMJoZXyVcufRj8r92zCKu3N2Ld449yv8vTDF4tULw8Pxd/iHtArZzdX3GxYcr8Yu1r/VtSv1r3kLv6fpJoZvyEUMMbf02bxJUY7RV77ce3npT1PRdVmts1dm7lWm9660YfBukqIfbc5YzGTCfCq1dXml8xNxo3GddI0WwuPS5Zd8jBl/spEj1L8zbJNTBjrMCl8CG3rT72ru3DqQ1W47uybtqhPvu5s1Tpjb8cj20VOY9kYFkoHZUapBiF6yiYhJqkjY3waUIvxOU1jwzD707HNqhbQAumF0WhpNHYAmCmdCemT4zk59mkSZXOSLEmyG7JN3KMoxjHmHBFy5vxJ6UXpAdIzSmOdHUqndBPz+xk7xIIdjfMEVZrW71Sf1Ah90SCU3/v0OSQxK8pak7dSN1wM0R4hNz3AByVAh9Db46Mkd/O5RbaE3BS5WHv15VNRRWbrYvMaQr70NUCMvF+M2LxonTCZsk7mVjtvfIhn7YMwBt6n4APM9kt5oIxpKbRgnAsp1XYXU9vA/93n36e/w/dh43BCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/static/d7902636fe64116f866fd153d196fb07/ca1dc/Untitled_1.png' srcset='/static/d7902636fe64116f866fd153d196fb07/e7570/Untitled_1.png 170w,\n/static/d7902636fe64116f866fd153d196fb07/f46e7/Untitled_1.png 340w,\n/static/d7902636fe64116f866fd153d196fb07/ca1dc/Untitled_1.png 680w,\n/static/d7902636fe64116f866fd153d196fb07/02d09/Untitled_1.png 1020w,\n/static/d7902636fe64116f866fd153d196fb07/9d567/Untitled_1.png 1360w,\n/static/d7902636fe64116f866fd153d196fb07/78873/Untitled_1.png 1520w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<ul>\n<li><code class=\"language-text\">SimpleMessageListnerContainer</code> 가 동작되는 방식은 아래 코드를 보면 알 수 있습니다.</li>\n<li>1번 : <code class=\"language-text\">AmazonSQS Client</code>를 통해 큐로 <code class=\"language-text\">Polling Request</code>를 전송하여 메시지를 응답 받습니다.</li>\n<li>2번 : 응답받은 메시지 수 만큼 <code class=\"language-text\">CountDownLatch</code> 객체를 생성합니다.</li>\n<li>\n<p>3번 : 응답받은 각 메시지를 For문으로 돌면서 할당받은 스레드풀에 작업을 등록합니다.</p>\n<ul>\n<li>스레드풀에 전달하는 <code class=\"language-text\">SignalExecutingRunnable</code>객체는 각 메시지가 처리되면 <code class=\"language-text\">CountDownLatch</code> 값을 Down 시킵니다.</li>\n</ul>\n</li>\n<li>5번 : <code class=\"language-text\">CountDownLatch</code> 가 0이 될때 까지 대기합니다.</li>\n</ul>\n<h3 id=\"낮은-처리량-문제\" style=\"position:relative;\">낮은 처리량 문제<a href=\"#%EB%82%AE%EC%9D%80-%EC%B2%98%EB%A6%AC%EB%9F%89-%EB%AC%B8%EC%A0%9C\" aria-label=\"낮은 처리량 문제 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p><code class=\"language-text\">SimpleMessageContainerListener</code> 의 구현에서의 문제점은 최대 10개 메시지를 수신하여 처리할 수 있고, 이 메시지 모두가 처리되면 다음 <code class=\"language-text\">Poilling</code> 을 시작합니다.  대부분의 스레드가 DB Blocking I/O 작업으로 인해 비효율적인 CPU 사용을 초래할 수 있고, 10개 메시지 중에 처리가 오래걸리는 메시지가 존재한다면 그 메시지가 처리될 때까지 다른  모든 스레드가 대기하게 되므로 Consumer의 처리량이 낮아지게 됩니다.</p>\n<h3 id=\"단일-Payload-Handling\" style=\"position:relative;\">단일 Payload Handling<a href=\"#%EB%8B%A8%EC%9D%BC-Payload-Handling\" aria-label=\"단일 Payload Handling permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">\t<span class=\"token annotation punctuation\">@SqsListener</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"async_ff.fifo\"</span><span class=\"token punctuation\">,</span> deletionPolicy <span class=\"token operator\">=</span> <span class=\"token class-name\">SqsMessageDeletionPolicy</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NEVER</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handle1</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Payload</span> <span class=\"token class-name\">ApplicationEventMessage</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"receieved Message {} \"</span> <span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@SqsListener</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"async_ff.fifo\"</span><span class=\"token punctuation\">,</span> deletionPolicy <span class=\"token operator\">=</span> <span class=\"token class-name\">SqsMessageDeletionPolicy</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NEVER</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handle2</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Payload</span> <span class=\"token class-name\">Message</span> message<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MessageHeaders</span> messageHeaders<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Acknowledgment</span> acknowledgment<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"receieved Message {} \"</span> <span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">async_ff.fifo</code> 큐에 대해서 <code class=\"language-text\">@SqsListener</code>로 메시지를 구독합니다.</li>\n<li>첫번쨰 핸들러의 페이로드 타입은 <code class=\"language-text\">ApplicationEventMessage</code> 이고, 두번째 핸들러 페이로드 타입은 <code class=\"language-text\">Message</code>입니다.</li>\n<li>위 코드를 돌려보면 아래와 같이 async<em>ff</em>fifo 큐에 중복된 핸들러로 맵핑할 수 없는 예외가 발생합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Ambiguous handler methods mapped for destination 'async_ff.fifo': {public void com.example.awssqspilot.springboot.listener.SqsMessageListener.handle1(com.example.awssqspilot.domain.model.ApplicationEventMessage,org.springframework.messaging.MessageHeaders,org.springframework.cloud.aws.messaging.listener.Acknowledgment) throws java.lang.InterruptedException, public void com.example.awssqspilot.springboot.listener.SqsMessageListener.handle2(org.springframework.messaging.Message,org.springframework.messaging.MessageHeaders,org.springframework.cloud.aws.messaging.listener.Acknowledgment) throws java.lang.InterruptedException}</code></pre></div>\n<h1><strong>3. Solution</strong></h1>\n<h2 id=\"1-처리량-극복\" style=\"position:relative;\"><strong>1. 처리량 극복</strong><a href=\"#1-%EC%B2%98%EB%A6%AC%EB%9F%89-%EA%B7%B9%EB%B3%B5\" aria-label=\"1 처리량 극복 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/1294f674f9fe2a3714d1db9df4a41a01/5ba40/Untitled_2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 30%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA0UlEQVR42j2RBwqFMBBEvf8ZBSui2Ht3P29gf2DMmpnMlgTrutp931bXtYVhaFEUWZqmlue5TdNkx3HYeZ7SbNummD3LMum7rhO377sQ8EEAIEFRFBbHsY3jqHMugO/7BBYcRaBlR0dxMoS8rsvmeba+74WmaWROjAaxV/c8jy3LIq5t278Wn4DMvt73lZiLtEoSzjCrqkojIMaAqvgHFIIZcYBgGAYZQJCpLEtLkkTZncOcZIAi0MJhBDxWy5C0QhtkYfcYzmcI3NRn74/hM/wBt03Ng1b+PCwAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/static/1294f674f9fe2a3714d1db9df4a41a01/ca1dc/Untitled_2.png' srcset='/static/1294f674f9fe2a3714d1db9df4a41a01/e7570/Untitled_2.png 170w,\n/static/1294f674f9fe2a3714d1db9df4a41a01/f46e7/Untitled_2.png 340w,\n/static/1294f674f9fe2a3714d1db9df4a41a01/ca1dc/Untitled_2.png 680w,\n/static/1294f674f9fe2a3714d1db9df4a41a01/02d09/Untitled_2.png 1020w,\n/static/1294f674f9fe2a3714d1db9df4a41a01/9d567/Untitled_2.png 1360w,\n/static/1294f674f9fe2a3714d1db9df4a41a01/5ba40/Untitled_2.png 2820w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<ul>\n<li>폴링 스레드에서 메시지를 처리하는 것이 아니라 <code class=\"language-text\">MessageHandler</code>로 메시지 처리를 위임합니다.</li>\n<li>폴링 스레드는 <code class=\"language-text\">MessageHandler</code> 에 작업만 전달하고 결과를 기다리지 않고, SQS Queue 로 다음 폴링 요청만 받습니다.</li>\n<li>MessageHandler는 <code class=\"language-text\">EventWorkThreadPool</code>을 구성하고, 비동기처리로 CPU burst time 을 높입니다.</li>\n</ul>\n<h2 id=\"2-단일-페이로드-극복\" style=\"position:relative;\"><strong>2. 단일 페이로드 극복</strong><a href=\"#2-%EB%8B%A8%EC%9D%BC-%ED%8E%98%EC%9D%B4%EB%A1%9C%EB%93%9C-%EA%B7%B9%EB%B3%B5\" aria-label=\"2 단일 페이로드 극복 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/8ccfce1580be71f0c0672d2fcd7bd4f2/c6049/Untitled_3.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 24.705882352941178%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAoElEQVR42oWQyQrFIAxF/f+v7EqQImrp4NTmcQIp3b1AUHOHJDr5E3NOzfu+NWut0nt/6+TzPC/fQYJwXZe01mSMoUICIhhvsJSSLMsiOWfFMDP+cRxadxht2ybeeyWHEHQK6w5uHAxLKbLvu2LwMOKN2bqu4s7z1O6ciBBAijHqnQkwRGA4xogxtMmpo3G2+/cfCFvf/o+T9S2/dbQ27Q8+QIYKnCaZuwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/static/8ccfce1580be71f0c0672d2fcd7bd4f2/ca1dc/Untitled_3.png' srcset='/static/8ccfce1580be71f0c0672d2fcd7bd4f2/e7570/Untitled_3.png 170w,\n/static/8ccfce1580be71f0c0672d2fcd7bd4f2/f46e7/Untitled_3.png 340w,\n/static/8ccfce1580be71f0c0672d2fcd7bd4f2/ca1dc/Untitled_3.png 680w,\n/static/8ccfce1580be71f0c0672d2fcd7bd4f2/02d09/Untitled_3.png 1020w,\n/static/8ccfce1580be71f0c0672d2fcd7bd4f2/9d567/Untitled_3.png 1360w,\n/static/8ccfce1580be71f0c0672d2fcd7bd4f2/c6049/Untitled_3.png 2798w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<h1><strong>4. Implementation</strong></h1>\n<h2 id=\"1-EventWorkPool-설정\" style=\"position:relative;\"><strong>1. EventWorkPool 설정</strong><a href=\"#1-EventWorkPool-%EC%84%A4%EC%A0%95\" aria-label=\"1 EventWorkPool 설정 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"eventWorkerPool\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">ThreadPoolTaskExecutor</span> <span class=\"token function\">eventWorkerPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token class-name\">ThreadPoolTaskExecutor</span> executor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadPoolTaskExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\texecutor<span class=\"token punctuation\">.</span><span class=\"token function\">setMaxPoolSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 스레드풀 개수를 설정합니다.</span>\n\texecutor<span class=\"token punctuation\">.</span><span class=\"token function\">setQueueCapacity</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 스레드풀 대기큐에 과도한 요청이 들어오는걸 방지하기 위해 대기큐 사이즈를 0으로 설정합니다.</span>\n\t<span class=\"token keyword\">return</span> executor<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"2-SqsMessageHandler-구현\" style=\"position:relative;\"><strong>2. SqsMessageHandler 구현</strong><a href=\"#2-SqsMessageHandler-%EA%B5%AC%ED%98%84\" aria-label=\"2 SqsMessageHandler 구현 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SqsMessageHandler</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AsyncTaskExecutor</span> eventWorkerPool<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MessageTypeDispatcher</span> messageTypeDispatcher<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Long</span> backOffTime <span class=\"token operator\">=</span> <span class=\"token number\">5000L</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>\n\t\t\t<span class=\"token keyword\">final</span> <span class=\"token class-name\">SqsMessage</span> message<span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token keyword\">final</span> <span class=\"token class-name\">MessageHeaders</span> messageHeaders<span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token keyword\">final</span> <span class=\"token class-name\">Acknowledgment</span> acknowledgment\n\t<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\n\t\t\teventWorkerPool<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n\n\t\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t<span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> result <span class=\"token operator\">=</span> messageTypeDispatcher<span class=\"token punctuation\">.</span><span class=\"token function\">doDispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">getMessageType</span><span class=\"token punctuation\">(</span>messageHeaders<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">getPayload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"EventWorkerPool Exception occurred\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token comment\">// noinspection BusyWait</span>\n\t\t\t\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>backOffTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> ie<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t\t\t\t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RejectedExecutionException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"eventThreadPool Queue is full. {}\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">throw</span> e<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">MessageType</span> <span class=\"token function\">getMessageType</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">MessageHeaders</span> messageHeaders<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageType</span><span class=\"token punctuation\">(</span>messageHeaders<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SqsMessageHeaders</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SQS_EVENT_TYPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"3-MessageDispatcher-구현\" style=\"position:relative;\"><strong>3. MessageDispatcher 구현</strong><a href=\"#3-MessageDispatcher-%EA%B5%AC%ED%98%84\" aria-label=\"3 MessageDispatcher 구현 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/2cf93942d77587adb10b1211c512a0b7/78873/Untitled_4.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 82.3529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/UlEQVR42n2TCW7bMBBFfZQWjSUuw+EyI4miLdV7nLq2UQQIev+TlJTTBGgTUw8fpKBPfc5Is4Ry7XBJzYZgxzAQDdwm76Pz0bqF970rEFql/x2zx3r+LL48qeoAeJT6p7InY6/El0CZk/NHdGe0P+Zz9epWZdzMrOXGh5G7tYO1Nz3oZHTCoj2oiTLxRgMCGDBo0XmDWMwKoGHfR7YBpbfKowqZMpEOlTUwqXGIWQ2g9zawtbaYHQBLQaLmuqaJUBVICJYSpoxZdb5yVnULLW/BZ1tRnc18mzNzu3JuFWjfdE992oYwVNWmqv6v03vB9qo+unl0wN3A3Pdxsdvst5td18bow2n+AHfMrRRXxpd19zzQSzIH1EMtxroepVgJaXPEO2YNQAR9h8xog1EGaq0zYuJO5mI2Bo2xMGlpA+ZCTpUFyIFBwz0zIlLTBmp8yNIQcyB2gXJXlJRvfGLOn4GXwbvsLd13wVgHeUtPgVtuO+K8Y2PggwizfG8kNYxjGtdx+X2x3qVx0w+rtNotl8txkZwP+SRmOsCNd7PUYJ0JwRpufRs5Jh+Ta1rbdI6CBiU01EqJj0o4Y6WSVJ0QUYiurl/JSymjVJleFW7L/CT9/SuK+VBVv/XXa0Mn7s6ef3G6ULw07Zn40bqjdScfjogHtHvrT8Y8P3x7e/MfIyyzgSiprs0AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/static/2cf93942d77587adb10b1211c512a0b7/ca1dc/Untitled_4.png' srcset='/static/2cf93942d77587adb10b1211c512a0b7/e7570/Untitled_4.png 170w,\n/static/2cf93942d77587adb10b1211c512a0b7/f46e7/Untitled_4.png 340w,\n/static/2cf93942d77587adb10b1211c512a0b7/ca1dc/Untitled_4.png 680w,\n/static/2cf93942d77587adb10b1211c512a0b7/02d09/Untitled_4.png 1020w,\n/static/2cf93942d77587adb10b1211c512a0b7/9d567/Untitled_4.png 1360w,\n/static/2cf93942d77587adb10b1211c512a0b7/78873/Untitled_4.png 1520w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>\n<ul>\n<li>JAVA Reflection 과 Spring Component 스캔을 이용해서 <code class=\"language-text\">dynamic dispatch</code>로 구현</li>\n<li><code class=\"language-text\">processor</code> 객체로 <code class=\"language-text\">messageType</code> 에 해당하는 <code class=\"language-text\">advice</code> 객체를 <code class=\"language-text\">get</code> 합니다.</li>\n<li>반환받은 advice 객체 정보를 이용해서 <code class=\"language-text\">target bean</code> 과 <code class=\"language-text\">method</code>를 가져옵니다.</li>\n<li><code class=\"language-text\">target method</code> 파라미터 타입에 맞게 ObjectMapper로 <code class=\"language-text\">json -> Object</code> 로 맵핑 후, <code class=\"language-text\">target method</code> 를 실행합니다.</li>\n</ul>\n<h2 id=\"4-사용\" style=\"position:relative;\">4. 사용<a href=\"#4-%EC%82%AC%EC%9A%A9\" aria-label=\"4 사용 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/4956f16a180f5e9878b1d72ab5c901a3/78873/Untitled_5.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 21.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnUlEQVR42m2MW47DIAxFs5npKDg4FINfkFYjzf7XVJPvXvmp6+PN5Xfqj8tjjuxTx/WnPljd5mV2mUzl0fvwxkq1POuzRlBURNxawSli2sVV3HgYdWosbNODn6/Oks9S8KiYbpgqtUq04FLoev37+y3GTbmaIgLGSRdRW2Q+IIVgT3cP7XskAGx5mUcIIB1rSmvJmPHE84z3sKzv+gBaGC6rZ28/QgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='Untitled' title='' src='/static/4956f16a180f5e9878b1d72ab5c901a3/ca1dc/Untitled_5.png' srcset='/static/4956f16a180f5e9878b1d72ab5c901a3/e7570/Untitled_5.png 170w,\n/static/4956f16a180f5e9878b1d72ab5c901a3/f46e7/Untitled_5.png 340w,\n/static/4956f16a180f5e9878b1d72ab5c901a3/ca1dc/Untitled_5.png 680w,\n/static/4956f16a180f5e9878b1d72ab5c901a3/02d09/Untitled_5.png 1020w,\n/static/4956f16a180f5e9878b1d72ab5c901a3/9d567/Untitled_5.png 1360w,\n/static/4956f16a180f5e9878b1d72ab5c901a3/78873/Untitled_5.png 1520w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>Untitled</figcaption>\n  </figure></p>","frontmatter":{"title":"Spring Cloud AWS Messaging 모듈 문제점 및 튜닝","date":"June 20, 2023","update":"June 20, 2023","tags":["AWS"],"series":null},"fields":{"slug":"/Spring Cloud AWS Messaging Module Best Practice/","readingTime":{"minutes":8.09}}},"seriesList":{"edges":[{"node":{"id":"296328f9-f83a-5280-ba4d-bd4de2c4a23a","fields":{"slug":"/ch1/"},"frontmatter":{"title":"1장 - 신뢰할 수 있고 확장 가능하며 유지보수하기 쉬운 애플리케이션"}}},{"node":{"id":"c9052258-da8a-5838-97d0-5affaae34156","fields":{"slug":"/ch2/"},"frontmatter":{"title":"2장 - 데이터 모델과 질의 언어"}}},{"node":{"id":"eaf68b24-edef-59b5-a7f4-4e9ea41b0321","fields":{"slug":"/ch3/"},"frontmatter":{"title":"3장 - 저장소와 검색"}}},{"node":{"id":"522e45a7-12b4-55ae-8295-4a720f58da60","fields":{"slug":"/ch4/"},"frontmatter":{"title":"4장 - 부호화와 발전"}}},{"node":{"id":"5413888c-b834-5d0a-a576-10b33121e612","fields":{"slug":"/ch5/"},"frontmatter":{"title":"5장 - 복제"}}},{"node":{"id":"b7dfee63-516c-5cf7-83bd-cfe07286f825","fields":{"slug":"/ch6/"},"frontmatter":{"title":"6장 - 파티셔닝"}}},{"node":{"id":"a652b497-d0e9-5d72-988a-35fb96da4202","fields":{"slug":"/ch7/"},"frontmatter":{"title":"7장 - 트랜잭션"}}},{"node":{"id":"142b9f9f-7ca6-5376-aa9b-55bd67d46ee3","fields":{"slug":"/ch8/"},"frontmatter":{"title":"8장 - 분산 시스템의 골칫거리"}}},{"node":{"id":"440239bd-9cf3-519f-86af-72f698bb3262","fields":{"slug":"/ch1/"},"frontmatter":{"title":"1부 - 성능 기초"}}},{"node":{"id":"2f0b9a48-2617-5e0a-ab00-4571b7e012c7","fields":{"slug":"/ch2/"},"frontmatter":{"title":"2부 - 성능 개선"}}},{"node":{"id":"60bb268c-033b-5cdd-bba3-9351aa771fb4","fields":{"slug":"/ch3/"},"frontmatter":{"title":"3부 - 화면 응답시간 분석"}}},{"node":{"id":"eee5ea21-1271-510f-9b52-f5c2b8e6f8ed","fields":{"slug":"/ch4/"},"frontmatter":{"title":"4부 - 프로세스 이해하기"}}},{"node":{"id":"e512cc83-75e1-552a-813b-543508957e1f","fields":{"slug":"/ch5/"},"frontmatter":{"title":"5부 - 소스코드 최적화"}}},{"node":{"id":"4db40817-9881-5aea-a6d4-b7b009c1a350","fields":{"slug":"/ch6/"},"frontmatter":{"title":"6부 - SQL 최적화"}}},{"node":{"id":"bb9c36ac-6d3d-53ff-891c-3d0e6d56115a","fields":{"slug":"/ch7/"},"frontmatter":{"title":"7부 - 애플리케이션 입장에서의 SQL 튜닝"}}},{"node":{"id":"15e07ee1-b1da-592c-97db-c67d8a458b0c","fields":{"slug":"/spring-autoconfigure/"},"frontmatter":{"title":"SpringBoot AutoConfiguration 시작하기"}}},{"node":{"id":"00a98f1e-f4b7-562e-b052-7c7bbf333a61","fields":{"slug":"/behavior/"},"frontmatter":{"title":"디자인 패턴 - 행동 패턴"}}},{"node":{"id":"d2b050d0-1ad6-5db3-8087-46c1ef770d5d","fields":{"slug":"/struct/"},"frontmatter":{"title":"디자인 패턴 - 구조 패턴"}}},{"node":{"id":"39f89aa8-d521-51b6-af7e-4f25f0648182","fields":{"slug":"/create/"},"frontmatter":{"title":"디자인 패턴 - 생성 패턴"}}},{"node":{"id":"8934dee6-96ba-552c-bcd6-49294d6e7cc2","fields":{"slug":"/Exactly_Once_Semantics/"},"frontmatter":{"title":"카프카는 어떻게 Exactly-Once Semantics 보장하나?"}}},{"node":{"id":"19fdfd91-656a-5e79-9d96-1f5a12da47ca","fields":{"slug":"/trasaction_in_kafka/"},"frontmatter":{"title":"카프카에서의 Transactions"}}},{"node":{"id":"acc5f56e-6968-539d-9ffc-483a26a0d5ee","fields":{"slug":"/enabling_exactly_once_kafka_streams/"},"frontmatter":{"title":"카프카 스트림즈의 정확히 한 번"}}},{"node":{"id":"3dcec820-a2a1-54a0-aaf6-fda09480d78d","fields":{"slug":"/Amazon SQS Deep Dive/"},"frontmatter":{"title":"Amazon SQS 딥다이브"}}},{"node":{"id":"4329bf0c-4a54-5d63-9354-7dd221de8490","fields":{"slug":"/Spring Cloud AWS Messaging Module Best Practice/"},"frontmatter":{"title":"Spring Cloud AWS Messaging 모듈 문제점 및 튜닝"}}},{"node":{"id":"b68512de-7b86-5edf-8547-d9e1103dbcf0","fields":{"slug":"/java-collection-wrapper/"},"frontmatter":{"title":"Collection Wrapper 클래스를 이용한 Service 계층 리팩토링 "}}},{"node":{"id":"bdf354b5-bb11-5ca5-b46f-4fe625963602","fields":{"slug":"/spring-cache-hierarchy/"},"frontmatter":{"title":"Spring Cache 로 캐시 계층 구조 사용하기"}}},{"node":{"id":"ca70e5d9-9f49-5e98-be76-85def8989dbf","fields":{"slug":"/redis-event-notifications/"},"frontmatter":{"title":"Redis Keyspace Notifications에 대해 알아보자"}}},{"node":{"id":"f4b0fec2-64a8-50c4-b32f-a4e3165b2c34","fields":{"slug":"/jpa-slow-cause/"},"frontmatter":{"title":"JPA가 느릴 수 밖에 없는 원초적인 이유"}}},{"node":{"id":"258fb9df-ac30-55cf-91f5-1d626b51fbc6","fields":{"slug":"/ehcache3/"},"frontmatter":{"title":"Ehcache3 캐시 라이브러리 소개 (with Spring Boot)"}}},{"node":{"id":"bc1f40bb-26d9-5ce5-8e40-26be0b6f4ec9","fields":{"slug":"/mysql-primary-key-design/"},"frontmatter":{"title":"고성능을 위한 MySQL Primary Key 설계 전략"}}},{"node":{"id":"9edb5e98-0831-5f05-99ac-5243f5e61ed1","fields":{"slug":"/tomcat/"},"frontmatter":{"title":"Apache Tomcat 이해하기(NIO Connector 중심)"}}},{"node":{"id":"be7a2fa8-5b1e-57c0-ac68-164a29e2c50a","fields":{"slug":"/socket_option/"},"frontmatter":{"title":"Java의 Socket Option 정리"}}},{"node":{"id":"380cd3ba-df02-5eb5-bd99-dd88eee889c3","fields":{"slug":"/tomcat-connection/"},"frontmatter":{"title":"Tomcat은 어떻게 Connection을 관리할까?"}}},{"node":{"id":"d3f01e89-0b7e-5518-b223-4f91816fe1fb","fields":{"slug":"/spring-core-container/"},"frontmatter":{"title":"스프링으로 알아보는 IoC 컨테이너의 원리와 이해"}}},{"node":{"id":"74a04ce6-75c4-5373-8a4a-e11360c4778b","fields":{"slug":"/socket_internal/"},"frontmatter":{"title":"요청이 급증하는 상황의 Connection reset by peer 트러블 슈팅"}}},{"node":{"id":"e9743b3d-5c40-582b-ba0f-d58108c30c9a","fields":{"slug":"/mysql-transaction-lock/"},"frontmatter":{"title":"MySQL 잠금과 트랜잭션 Deep Dive"}}},{"node":{"id":"6f0905d8-70e8-531e-b3fa-a1df160991b9","fields":{"slug":"/java-synchronized/"},"frontmatter":{"title":"자바의 synchronized와 volatile"}}}]},"previous":{"fields":{"slug":"/Amazon SQS Deep Dive/"},"frontmatter":{"title":"Amazon SQS 딥다이브"}},"next":{"fields":{"slug":"/java-collection-wrapper/"},"frontmatter":{"title":"Collection Wrapper 클래스를 이용한 Service 계층 리팩토링 "}}},"pageContext":{"id":"4329bf0c-4a54-5d63-9354-7dd221de8490","series":null,"previousPostId":"3dcec820-a2a1-54a0-aaf6-fda09480d78d","nextPostId":"b68512de-7b86-5edf-8547-d9e1103dbcf0"}},"staticQueryHashes":[],"slicesMap":{}}