{"componentChunkName":"component---src-templates-post-jsx","path":"/socket_internal/","result":{"data":{"site":{"siteMetadata":{"title":"SOOLAB"}},"markdownRemark":{"id":"74a04ce6-75c4-5373-8a4a-e11360c4778b","excerpt":"문제 상황 소켓을 활용하여 서버-클라이언트 간 통신을 진행하는 과정에서, 클라이언트로부터의 요청이 일시적으로 급증하는 상황을 테스트하던 중,\n클라이언트 측에서  라는 예외가 간헐적으로 발생하였다. 아래는 해당 예외가 발생했을 때 클라이언트 측에서 기록된 로그이다. 는 클라이언트가 서버로부터 정상적으로 응답을 받아 출력한 메시지이다.\n그 아래에 나타나는  …","html":"<h2 id=\"문제-상황\" style=\"position:relative;\">문제 상황<a href=\"#%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9\" aria-label=\"문제 상황 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>소켓을 활용하여 서버-클라이언트 간 통신을 진행하는 과정에서, 클라이언트로부터의 요청이 일시적으로 급증하는 상황을 테스트하던 중,\n클라이언트 측에서 <code class=\"language-text\">Connection reset by peer</code> 라는 예외가 간헐적으로 발생하였다. 아래는 해당 예외가 발생했을 때 클라이언트 측에서 기록된 로그이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hello, world!\nHello, world!\nHello, world!\norg.springframework.web.client.ResourceAccessException: I/O error: Connection reset by peer; nested exception is java.net.SocketException: Connection reset by peer\n\tat org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:453)\n\tat org.springframework.web.client.RestTemplate.execute(RestTemplate.java:401)\n\tat org.springframework.web.client.RestTemplate.getForObject(RestTemplate.java:199)\n\tat com.example.ehcache.EhcacheApplication2.lambda$main$0(EhcacheApplication2.java:35)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\n\tat java.base/java.lang.Thread.run(Thread.java:833)\nCaused by: java.net.SocketException: Connection reset by peer\n\tat java.base/sun.nio.ch.Net.connect0(Native Method)\n\tat java.base/sun.nio.ch.Net.connect(Net.java:579)\n\tat java.base/sun.nio.ch.Net.connect(Net.java:568)</code></pre></div>\n<p><code class=\"language-text\">Hello, world!</code>는 클라이언트가 서버로부터 정상적으로 응답을 받아 출력한 메시지이다.\n그 아래에 나타나는 <code class=\"language-text\">java.net.SocketException: Connection reset by peer</code> 예외는 RestTemplate을 통한 소켓 통신 중 발생했다는 것을 확인할 수 있다.</p>\n<p>해당 문제가 발생한 서버-클라이언트 코드는 아래와 같다.\n여기서 서버는 스레드풀 기반의 간단한 HTTP 서버를 구현하였고, 클라이언트는 이 서버에 스레드 1000개를 사용하여 동시에 요청을 보내는 구조를 가지고 있다.</p>\n<h4>Server</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ServerExampleApplication</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> <span class=\"token number\">8100</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">NUM_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token class-name\">ExecutorService</span> executorService <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NUM_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ServerSocket</span> serverSocket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServerSocket</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token class-name\">Socket</span> socket <span class=\"token operator\">=</span> serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\texecutorService<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ClientHandler</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClientHandler</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Socket</span> socket<span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">ClientHandler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Socket</span> socket<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>socket <span class=\"token operator\">=</span> socket<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token annotation punctuation\">@Override</span>\n\t\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token class-name\">BufferedReader</span> input <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BufferedReader</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InputStreamReader</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span><span class=\"token function\">getInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\tinput<span class=\"token punctuation\">.</span><span class=\"token function\">readLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t\t<span class=\"token class-name\">PrintWriter</span> writer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PrintWriter</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span><span class=\"token function\">getOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\twriter<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"HTTP/1.1 200 OK\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\twriter<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type: text/plain\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\twriter<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Connection: close\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\twriter<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\twriter<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello, world!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t\twriter<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\tinput<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Client</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Client</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"http://localhost:8100\"</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">NUM_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token class-name\">ExecutorService</span> es <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NUM_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">RestTemplate</span> restTemplate <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RestTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token constant\">NUM_THREADS</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tes<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span>\n\t\t\t\t\t<span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t\t<span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">getForObject</span><span class=\"token punctuation\">(</span><span class=\"token constant\">URL</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\tes<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tes<span class=\"token punctuation\">.</span><span class=\"token function\">awaitTermination</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SECONDS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>시스템 환경에 따라 예외 재현이 안될 수 있다.</p>\n</blockquote>\n<p>요청량이 많아 서버의 리소스가 부족해져 요청을 제대로 처리하지 못하는 상황이 이해는 가지만, 시스템이 요청을 처리할지 여부를 결정하는 기준이 무엇인지에 대해 궁금증이 생겼다.</p>\n<p>이번 글에서는 요청이 폭증하는 상황에서 발생하는 <code class=\"language-text\">Connection reset by peer</code> 예외의 원인을 깊이 있게 분석한다.</p>\n<h2 id=\"원인-분석-과정\" style=\"position:relative;\">원인 분석 과정<a href=\"#%EC%9B%90%EC%9D%B8-%EB%B6%84%EC%84%9D-%EA%B3%BC%EC%A0%95\" aria-label=\"원인 분석 과정 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"패킷-분석\" style=\"position:relative;\">패킷 분석<a href=\"#%ED%8C%A8%ED%82%B7-%EB%B6%84%EC%84%9D\" aria-label=\"패킷 분석 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>클라이언트 쪽에서 <code class=\"language-text\">Connection reset by peer</code> 예외가 발생했지만, 서버 애플리케이션 단에서는 어떤 예외도 잡아낼 수 없었다.\n상황을 더 자세히 파악하기 위해 Wireshark를 사용해 패킷을 분석하였다.\n아래 <strong>그림 1</strong>은 문제가 발생한 시점의 서버-클라이언트 소켓 통신 패킷 캡쳐 화면이다.\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/caebe6ce8ad4511e6b3105eb35dbb515/f8d80/img.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 6.470588235294117%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAS0lEQVR42i3KOQ6AIBQAUe/foQWfTQ1WIgJxOd9ojMU0L9NVM5LFUyRwhUg1E+212y8UHcjaUezI/n+pNyQlX6vSbIOlycxhI6eLPBkEOZ/PcIT8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='[그림1]문제가 발생한 서버-클라이언트 소켓 통신' title='' src='/static/caebe6ce8ad4511e6b3105eb35dbb515/ca1dc/img.png' srcset='/static/caebe6ce8ad4511e6b3105eb35dbb515/e7570/img.png 170w,\n/static/caebe6ce8ad4511e6b3105eb35dbb515/f46e7/img.png 340w,\n/static/caebe6ce8ad4511e6b3105eb35dbb515/ca1dc/img.png 680w,\n/static/caebe6ce8ad4511e6b3105eb35dbb515/02d09/img.png 1020w,\n/static/caebe6ce8ad4511e6b3105eb35dbb515/9d567/img.png 1360w,\n/static/caebe6ce8ad4511e6b3105eb35dbb515/f8d80/img.png 1516w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>[그림1]문제가 발생한 서버-클라이언트 소켓 통신</figcaption>\n  </figure></p>\n<ul>\n<li>3842번 패킷 : 클라이언트 -> 서버로 <code class=\"language-text\">SYN</code> 패킷을 전송하였다.</li>\n<li>3843번 패킷 : 서버 -> 클라이언트로 <code class=\"language-text\">SYN,ACK</code> 으로 응답하였다.</li>\n<li>3845번 패킷 : 클라이언트 -> 서버로 <code class=\"language-text\">ACK</code>로 응답 후, 3-way Handshake가 완료되었다.</li>\n<li>3848번 패킷 : 서버 -> 클라이언트로 <code class=\"language-text\">RST</code> 패킷을 전송한다.</li>\n</ul>\n<p>캡쳐된 패킷을 살펴보면 정상적인 TCP 3-way Handshake가 진행된 후, 서버에서 RST 패킷을 전송하여 연결을 강제로 종료하였다.\nRST 패킷은 연결의 문제나 예외적인 상황에서 전송되므로 해당 연결에 문제가 발생했음을 알 수 있다.</p>\n<p>문제 상황에서 클라이언트가 출력한 스택 트레이스를 살펴보면, socket.connect() 를 수행 중 예외가 발생한 것을 확인할 수 있다.\n즉, 클라이언트 소켓이 connect()를 호출해 수행하던 중 3-way Handshake를 완료한 후에 서버로부터 RST 패킷을 받아 <code class=\"language-text\">Connection reset by peer</code> 예외가 발생된 것으로 확인된다.</p>\n<h3 id=\"테스트-환경-전환\" style=\"position:relative;\">테스트 환경 전환<a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%ED%99%98%EA%B2%BD-%EC%A0%84%ED%99%98\" aria-label=\"테스트 환경 전환 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>애플리케이션 로그와 패킷 분석 결과, 예외가 애플리케이션 레벨보다는 OS나 TCP/IP 프로토콜 레벨에서 발생한 것 추측되었다.\n패킷 분석에서 서버가 RST 패킷을 전송한 걸 확인했는데, 애플리케이션에는 <code class=\"language-text\">RST</code> 패킷을 전송하는 로직이나 패킷을 보낼 조건을 결정하는 로직이 없기 때문이다.</p>\n<p>원인을 보다 구체적으로 파악하기 위해 MacOS 환경 대신 리눅스 환경에서 동일한 서버-클라이언트 코드로 테스트를 해보기로 결정했다.\nDocker를 사용해 리눅스 환경을 구성하고 테스트를 진행했다. 여기서는 ubuntu 리눅스를 선택했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">-v</span> ~/docker/linux:/home ubuntu</code></pre></div>\n<p>동일한 서버-클라이언트 코드를 사용해 테스트 했을 때, 같은 스레드와 부하에도 불구하고 리눅스 환경에서는 <code class=\"language-text\">Connection reset by peer</code> 예외가 한 번도 발생하지 않았다.\n여러번 테스트해도 결과는 같았고 심지어 클라이언트 부하를 증가시켜도 예외가 발생하지 않았다.\n이 결과로 볼 때, 서버가 클라이언트에게 <code class=\"language-text\">RST</code> 패킷을 전송하는 결정 및 과정이 OS나 TCP/IP 프로토콜 레벨에서 이루어지고 있을 가능성이 매우 높아졌다.</p>\n<h3 id=\"소켓-내부-로직-분석\" style=\"position:relative;\">소켓 내부 로직 분석<a href=\"#%EC%86%8C%EC%BC%93-%EB%82%B4%EB%B6%80-%EB%A1%9C%EC%A7%81-%EB%B6%84%EC%84%9D\" aria-label=\"소켓 내부 로직 분석 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>리눅스 환경에서 예외가 재현되지 않는 것을 확인 후, Socket 클래스 내부 동작을 살펴보았다.\nSocket 클래스의 연산은 결국 PlainSocketImpl 클래스의 native 메서드를 호출하는 것을 확인할 수 있었다.\n이러한 네이티브 메서드는 OS의 시스템 호출을 통해 소켓 작업을 처리한다. 따라서, 시스템 레벨에서 소켓이 어떻게 동작되는지 확인이 필요하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">PlainSocketImpl</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractPlainSocketImpl</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// [...]</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketCreate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> stream<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> isServer<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketConnect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">InetAddress</span> address<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> port<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> timeout<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketBind</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">InetAddress</span> address<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> port<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketListen</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> count<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketAccept</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocketImpl</span> s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">int</span> <span class=\"token function\">socketAvailable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketClose0</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> useDeferredClose<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketShutdown</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> howto<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">static</span> <span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">initProto</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketSetOption0</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> cmd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> on<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> value<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">int</span> <span class=\"token function\">socketGetOption</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> opt<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> iaContainerObj<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketSendUrgentData</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> data<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"소켓-통신-내부-구조\" style=\"position:relative;\">소켓 통신 내부 구조<a href=\"#%EC%86%8C%EC%BC%93-%ED%86%B5%EC%8B%A0-%EB%82%B4%EB%B6%80-%EA%B5%AC%EC%A1%B0\" aria-label=\"소켓 통신 내부 구조 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>RST 패킷의 원인을 파악하기 위해, 소켓 통신의 내부 구조를 살펴보자.\n먼저, 서버에서 클라이언트의 요청을 수락하는 accept 시스템 호출에 대한 설명을 man 명령어로 확인하면 다음과 같다.<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">man</span> accept</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">accept() extracts the first connection request on the queue\nof pending connections, creates a new socket with the same properties of\nsocket, and allocates a new file descriptor for the socket. If no\npending connections are present on the queue, and the socket is not\nmarked as non-blocking, accept() blocks the caller until a connection is present.</code></pre></div>\n<blockquote>\n<p>accept() 함수는 대기 중인 연결 요청의 큐에서 첫 번째 연결 요청을 추출하여,\n해당 소켓과 동일한 속성을 가진 새로운 소켓을 생성하고 그 소켓에 대한 새로운 파일 디스크립터를 할당한다.\n큐에 대기 중인 연결이 없고 소켓이 non-blocking으로 설정되지 않은 경우, accept()는 연결이 있을 때까지 호출자를 차단한다.</p>\n</blockquote>\n<p>man 에서 설명된 내용을 기반으로 소켓 내부적으로 연결 요청을 위한 대기열를 내부적으로 유지한 다는 것을 알 수 있다.\n소켓 통신 과정 중, 내부에 대기열이 존재한다는 실마리를 통해 관련 자료를 참조하여 내용을 정리할 수 있었다.\n참조한 자료는 맨 아래 더 읽을거리에 정리해두었다.</p>\n<h3 id=\"SYN-큐와-accept-큐\" style=\"position:relative;\">SYN 큐와 accept 큐<a href=\"#SYN-%ED%81%90%EC%99%80-accept-%ED%81%90\" aria-label=\"SYN 큐와 accept 큐 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>리눅스 커널은 3-Way Handshake 과정 중 내부적으로 SYN 큐와 accept 큐를 유지한다.\n아래 프로세스는 3-Way Handshake 과정 중 두 개의 큐가 어떻게 사용되는 지를 설명한다.</p>\n<ol>\n<li>클라이언트는 서버에 연결을 시작하려고 SYN 패킷을 보내고, 이후 <code class=\"language-text\">SYN_SENT</code> 상태로 들어간다.</li>\n<li>서버는 클라이언트의 SYN 요청을 받으면 <code class=\"language-text\">SYN_RECV</code> 상태로 변경된다. 이때, 커널은 이 연결 정보를 SYN 큐에 저장하고 클라이언트에게 SYN+ACK 패킷을 응답한다.</li>\n<li>클라이언트는 서버로부터 받은 SYN + ACK를 받고, ACK를 서버에게 응답하면서 <code class=\"language-text\">ESTABLISHED</code> 상태로 변경된다.</li>\n<li>서버는 클라이언트로부터의 ACK를 받으면, 커널은 연결 정보를 SYN 큐에서 제거하고 accept 큐에 추가한다. 그 후 서버는 <code class=\"language-text\">ESTABLISHED</code> 상태로 들어간다.</li>\n<li>서버 애플리케이션에서 accept 함수를 호출하면, 연결은 accept 큐에서 꺼내진다.</li>\n</ol>\n<p>아래 <strong>그림2</strong>는 위 프로세스를 다이어그램으로 표현한 것 이다.\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/5fa15322156f084449a8ed27ed873cf9/045f5/img_1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 100.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC4klEQVR42oVUTW/aQBTk/1966rmXqodKvVc59FKpqdoqUiBJE0IgBPAHGH+sP9a7/pjOrjGEJKi2ng328+y8N/N2oPUYafoJRfEFVb1BCzAaRn82aPiwLH8w7yOU+oq6rnZ5r8+B1tfYbN5DiA8E9J8lYv/bAOb5GXzvHe+foWtll2xenBawZXJV1WjMVycOkyPEFqvVDFEckGF9MndgLlXFEtrTgObIs4iVLJESuKkbHEogr6axYX6zZIk4WttE05tTDNM0gLMaQyQ+tNIEYMkG5CiRDPMswWJ+B2cxhi6LkwzrWkMWGYo8I9scSRghEwUXeoLjnMFzv6HSUVdyWYTYPJ3Df/yOXGygdAUppWVgWpHLEmmh6AQFVZbQWvOuLCNTWZYukGVLLqoMYEvkEk1FgFoSoLECRWQgEsF2xLh58HBx62K6ZFsqjVLVmDoKk1UFJyj3bbElmz9pkWA4vcRwNsRoOqSSIVKCGUDD5lB2p66uW4KV+DuXHaAhUXfVWEClCsRUMckj3kOWW0DEwpblBS4myzEenHs8rqa2fzKX7Kck2/ot27S24S9tY5LNqpt4TTb3BJzA2ayswkVOMUSKhIuWMkUU3SDcXpLIetfDis5vzTjVNmxDep8dKd0xMr41wOa9kgKe95sq/6QwqwNg25rkpovD3Fm/Wc+RbUX1zTPDfp14cJMVvNg5mpxB7zGj7luAe2AC2g93rRmvb/Frfo4bd8Q9oPveitJwOoqcvSgz1I3umLbtnlkfYeRiNruC78/puwxpnkJwKEpOmnnfLzyQbKrrTOk7x3rs1KGVpI223G0ES9ddMc9Gbg9ohjoI17i4+4PRbITx8g6JSKhaSBUT3C/vcf14jasZlUyjnYnbfX+PBOyNLbm6sceaESQcPcURk8r6cCsC+JGPuTuBHyxQkmFje4k3Y2AuRr0jH7avd5sij7kfTmh4n2P6H8B+E+jjSN3dM2ObPu8UmAH8B0I4E+p9tuhHAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='[그림2] 소켓 통신 과정' title='' src='/static/5fa15322156f084449a8ed27ed873cf9/ca1dc/img_1.png' srcset='/static/5fa15322156f084449a8ed27ed873cf9/e7570/img_1.png 170w,\n/static/5fa15322156f084449a8ed27ed873cf9/f46e7/img_1.png 340w,\n/static/5fa15322156f084449a8ed27ed873cf9/ca1dc/img_1.png 680w,\n/static/5fa15322156f084449a8ed27ed873cf9/045f5/img_1.png 797w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>[그림2] 소켓 통신 과정</figcaption>\n  </figure></p>\n<p>SYN 큐는 1번에서 클라이언트가 보내온 SYN 패킷<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup>을 저장한다.\nSYN + ACK 패킷으로 응답하고, 클라이언트로부터 ACK 응답이 오지 않을 경우 재시도하기 위해 클라이언트 요청을 일시적으로 저장하기 위한 용도이다.</p>\n<p>애플리케이션에서 accept()를 호출하지 않아도 클라이언트로 ACK 까지 받게되면 서버와 클라이언트 모두 <code class=\"language-text\">ESTABLISHED</code> 상태이다.\naccept 큐는 4번에서 클라이언트로부터의 ACK 응답을 일시적으로 저장해두고, accept()가 호출되면 이 대기열에서 제거되고 애플리케이션에 전달된다.</p>\n<p>SYN 큐와 accept 큐의 크기를 결정하는 관련 커널 파리미터는 아래와 같다.<sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sysctl</span> net.ipv4.tcp_max_syn_backlog\n<span class=\"token function\">sysctl</span> net.core.somaxconn </code></pre></div>\n<blockquote>\n<p>tcp_max_syn_backlog :\nMaximal number of remembered connection requests, which have not\nreceived an acknowledgment from connecting client.\nThe minimal value is 128 for low memory machines, and it will\nincrease in proportion to the memory of machine.\nIf server suffers from overload, try increasing this number.</p>\n</blockquote>\n<blockquote>\n<p>somaxconn :\nLimit of socket listen() backlog, known in userspace as SOMAXCONN.\nDefaults to 128. See also tcp_max_syn_backlog for additional tuning\nfor TCP sockets.</p>\n</blockquote>\n<h3 id=\"listen\" style=\"position:relative;\">listen()<a href=\"#listen\" aria-label=\"listen permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>listen 함수를 호출할 때, 두 번째 인수로 주어지는 backlog는 대기 중인 연결 요청의 최대 수를 정의한다.\naccept 큐의 크기 결정에 있어서, somaxconn 커널 파라미터와 listen 함수의 backlog 인자 두 가지가 중요한 역할을 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> sockfd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> backlog<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>accept 큐의 크기를 결정하는 방식은 공식 문서에 따르면 다음과 같이 설명되어 있다.<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup></p>\n<blockquote>\n<p>Now it specifies the queue length for completely\nestablished sockets waiting to be accepted, instead of the number\nof incomplete connection requests. The maximum length of the\nqueue for incomplete sockets can be set using\n/proc/sys/net/ipv4/tcp_max_syn_backlog. When syncookies are\nenabled there is no logical maximum length and this setting is\nignored. See tcp(7) for more information.\nIf the backlog argument is greater than the value in\n/proc/sys/net/core/somaxconn, then it is silently capped to that\nvalue. Since Linux 5.4, the default in this file is 4096; in\nearlier kernels, the default value is 128. Before Linux 2.4.25,\nthis limit was a hard coded value, SOMAXCONN, with the value 128.</p>\n</blockquote>\n<p>요약하면, backlog 값이 /proc/sys/net/core/somaxconn보다 크면, 자동으로 somaxconn 값으로 제한된다.\n불완전한 연결의 최대 큐 길이는 /proc/sys/net/ipv4/tcp_max_syn_backlog로 설정이 가능하며, Linux 2.2 이전에는 somaxconn 값이 불완전한 연결 요청의 수를 나타내었다고 한다.\n즉, accept 큐의 크기는 <strong>min(somaxconn, backlog)</strong> 값으로 설정된다.</p>\n<h2 id=\"검증-및-테스트\" style=\"position:relative;\">검증 및 테스트<a href=\"#%EA%B2%80%EC%A6%9D-%EB%B0%8F-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"검증 및 테스트 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>리눅스 환경에서 커널 파라미터 설정을 테스트하기 위한 서버-클라이언트 코드를 아래와 같이 작성한다.</p>\n<h4>Server</h4>\n<p>ServerSocket 인스턴스를 생성하여 연결을 대기하는 상태로 유지하되, accept() 메서드를 호출하여 연결을 수락하지는 않는다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Server</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> <span class=\"token number\">8100</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ServerSocket</span> serverSocket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServerSocket</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Client</h4>\n<p>RestTemplate을 사용하여 서버에 NUM_THREADS 개수만큼의 요청을 1초 간격으로 전송한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Client</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"http://localhost:8100\"</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">NUM_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token class-name\">ExecutorService</span> es <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NUM_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">RestTemplate</span> restTemplate <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RestTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token constant\">NUM_THREADS</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tes<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span>\n\t\t\t\t\t<span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t\t<span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">getForObject</span><span class=\"token punctuation\">(</span><span class=\"token constant\">URL</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\tes<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tes<span class=\"token punctuation\">.</span><span class=\"token function\">awaitTermination</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SECONDS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>somaxconn=5, 요청 10개인 경우</h4>\n<p>somaxconn 파라미터를 5로 설정하여 서버를 시작하고 10개의 클라이언트 요청을 전송한다. 이후 netstat을 사용하여 소켓의 상태를 확인한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo sysctl -w kern.ipc.somaxconn=5</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ netstat -an | grep 8100\ntcp        6      0 0.0.0.0:8888            0.0.0.0:*               LISTEN\ntcp        0      1 127.0.0.1:57826         127.0.0.1:8888          SYN_SENT\ntcp        0      0 127.0.0.1:57824         127.0.0.1:8888          ESTABLISHED\ntcp        0      1 127.0.0.1:57832         127.0.0.1:8888          SYN_SENT\ntcp      116      0 127.0.0.1:8888          127.0.0.1:57814         ESTABLISHED\ntcp        0      1 127.0.0.1:57828         127.0.0.1:8888          SYN_SENT\ntcp      116      0 127.0.0.1:8888          127.0.0.1:57818         ESTABLISHED\ntcp      116      0 127.0.0.1:8888          127.0.0.1:57824         ESTABLISHED\ntcp        0      0 127.0.0.1:57822         127.0.0.1:8888          ESTABLISHED\ntcp        0      0 127.0.0.1:57820         127.0.0.1:8888          ESTABLISHED\ntcp        0      1 127.0.0.1:57830         127.0.0.1:8888          SYN_SENT\ntcp      116      0 127.0.0.1:8888          127.0.0.1:57820         ESTABLISHED\ntcp      116      0 127.0.0.1:8888          127.0.0.1:57816         ESTABLISHED\ntcp      116      0 127.0.0.1:8888          127.0.0.1:57822         ESTABLISHED\ntcp        0      0 127.0.0.1:57818         127.0.0.1:8888          ESTABLISHED\ntcp        0      0 127.0.0.1:57814         127.0.0.1:8888          ESTABLISHED\ntcp        0      0 127.0.0.1:57816         127.0.0.1:8888          ESTABLISHED</code></pre></div>\n<p>netstat을 통해 확인했을 때, <code class=\"language-text\">ESTABLISHED</code> 상태인 소켓쌍이 총 6개 생성되었고, 나머지 4개의 요청이 <code class=\"language-text\">SYN_SENT</code> 상태로 남아있는 것을 볼 수 있다.\n즉, <code class=\"language-text\">ESTABLISHED</code> 상태인 소켓이 somaxconn의 한계에 도달하면, 그 이후의 요청들은 클라이언트 측에서 <code class=\"language-text\">SYN_SENT</code> 상태로 대기하게 된다.\n<code class=\"language-text\">SYN_SENT</code> 상태인 클라이언트 소켓은 SYN + ACK 응답을 받지 못하여, 일정 시간을 지나면 타임아웃 처리되어 드롭된다.\n이 때, 클라이언트에서 <code class=\"language-text\">Caused by: java.net.ConnectException: Operation timed out</code> 예외를 받을 수 있다.</p>\n<p>somaxconn을 5로 설정했지만 <code class=\"language-text\">ESTABLISHED</code> 상태 소켓이 6쌍인 이유는 accept 큐가 꽉 차 있는지 여부를 검사하는 로직에서 >= 조건 대신 > 조건을 사용하기 때문에 최대 backlog 값보다 1개를 더 받게된다.<sup id=\"fnref-5\"><a href=\"#fn-5\" class=\"footnote-ref\">5</a></sup>\n이는 커널 버전이나 운영체제 별로 다를 수 있으니 참고하길 바란다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> bool <span class=\"token function\">sk_acceptq_is_full</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sock</span> <span class=\"token operator\">*</span>sk<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">READ_ONCE</span><span class=\"token punctuation\">(</span>sk<span class=\"token operator\">-></span>sk_ack_backlog<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token function\">READ_ONCE</span><span class=\"token punctuation\">(</span>sk<span class=\"token operator\">-></span>sk_max_ack_backlog<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다음으로, 4개의 소켓이 <code class=\"language-text\">SYN_SENT</code> 상태인 것을 확인할 수 있다.\n그런데 특이한 점은 SYN 큐가 가득 차 있지 않아도 해당 소켓들이 <code class=\"language-text\">SYN_RECV</code> 상태가 아닌 <code class=\"language-text\">SYN_SENT</code> 상태에 있다는 점이다.\n이 상황은 클라이언트가 SYN 패킷을 보냈지만 서버에서 SYN + ACK 응답을 받지 못한 상황을 나타낸다.\naccept 큐가 가득 찰 경우 SYN 큐에 요청이 순서대로 저장되어 <code class=\"language-text\">SYN_RECV</code> 상태를 예상했는데, 정확한 원인은 커널 소스에서 확인해볼 수 있었다.\n아래는 커널 소스에 일부분이다.</p>\n<p>listen() 이후 클라이언트 요청이 오면 아래 <code class=\"language-text\">tcp_conn_request</code><sup id=\"fnref-6\"><a href=\"#fn-6\" class=\"footnote-ref\">6</a></sup> 함수가 실행된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">tcp_conn_request</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">request_sock_ops</span> <span class=\"token operator\">*</span>rsk_ops<span class=\"token punctuation\">,</span>\n\t\t     <span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tcp_request_sock_ops</span> <span class=\"token operator\">*</span>af_ops<span class=\"token punctuation\">,</span>\n\t\t     <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sock</span> <span class=\"token operator\">*</span>sk<span class=\"token punctuation\">,</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sk_buff</span> <span class=\"token operator\">*</span>skb<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>syncookies <span class=\"token operator\">==</span> <span class=\"token number\">2</span> <span class=\"token operator\">||</span> <span class=\"token function\">inet_csk_reqsk_queue_is_full</span><span class=\"token punctuation\">(</span>sk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>isn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\twant_cookie <span class=\"token operator\">=</span> <span class=\"token function\">tcp_syn_flood_action</span><span class=\"token punctuation\">(</span>sk<span class=\"token punctuation\">,</span> rsk_ops<span class=\"token operator\">-></span>slab_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>want_cookie<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">goto</span> drop<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">sk_acceptq_is_full</span><span class=\"token punctuation\">(</span>sk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">NET_INC_STATS</span><span class=\"token punctuation\">(</span><span class=\"token function\">sock_net</span><span class=\"token punctuation\">(</span>sk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> LINUX_MIB_LISTENOVERFLOWS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">goto</span> drop<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n\t<span class=\"token comment\">// ... 중략</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 소스에서 첫 번째 if문은 <code class=\"language-text\">inet_csk_reqsk_queue_is_full()</code> 함수를 통해 SYN 큐가 꽉 찼는지 확인한다.\n만약 꽉 찼다면, 바로 드롭 처리가 되는 것을 볼 수 있다.\n다음으로 <code class=\"language-text\">sk_acceptq_is_full()</code> 함수로 accept 큐가 꽉 찼는지 확인하고, 꽉 차 있을 경우에도 드롭 처리한다.\n즉, SYN 큐는 꽉 차 있지 않아도 accept 큐가 꽉 차면 요청이 드롭된다는 것을 알 수 있다.</p>\n<blockquote>\n<p>SYN 큐는 내용이 복잡하고 방대하여 여기서 다루지는 않는다. SYN 큐에 관한 자세한 내용은 아래 첨부된 링크를 통해 참조할 수 있다.<sup id=\"fnref-7\"><a href=\"#fn-7\" class=\"footnote-ref\">7</a></sup><sup id=\"fnref-8\"><a href=\"#fn-8\" class=\"footnote-ref\">8</a></sup></p>\n</blockquote>\n<h2 id=\"Connection-reset-by-peer\" style=\"position:relative;\">Connection reset by peer<a href=\"#Connection-reset-by-peer\" aria-label=\"Connection reset by peer permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>테스트를 통해 somaxconn 크기만큼 accept 큐 크기가 결정되는 것을 확인할 수 있었다.\naccept 큐가 꽉 차더라도 <code class=\"language-text\">Connection reset by peer</code> 예외는 발생하지 않았다.\n대신 큐가 꽉 찬 후로는 들어오는 요청이 <code class=\"language-text\">SYN_SENT</code> 상태에서 멈춰 타임아웃이 발생했다.</p>\n<p>그렇다면 <code class=\"language-text\">Connection reset by peer</code> 예외는 언제 발생하는 것일까?\n결론부터 말하면 SYN 큐에 accept 큐 사이즈를 초과하는 요청이 몰릴 경우, SYN 큐에서 accept 큐로 이동하는 과정에서 accept 큐의 오버플로가 발생하게 되면, 그 추가 요청에 대해서 <code class=\"language-text\">Connection reset by peer</code> 예외가 발생한다.</p>\n<p>위의 테스트 로직에서 클라이언트에서 1초 간격으로 10개의 요청을 보내도록 하였다. 1초는 3-Way-Handshaking을 하는데 충분한 시간으로\n요청 패킷이 SYN 큐 -> accept 큐까지 가는데 충분한 시간이다. 그래서 결국 SYN 큐에는 요청들이 머물지 않고 accept 큐에서만 요청이 머물게 된다.\n요청마다 충분한 텀이 있기 때문에 accept 큐에만 요청이 쌓이다가 그 이상의 요청이 오게 되면 서버에서는 ACK 응답을 주지 않고 클라이언트 측에서는 timeout이 발생한다.</p>\n<p>만약 클라이언트 요청 간의 1초 간격을 없애면 어떻게 될까? SYN 큐의 크기가 10이고, accept 큐 크기가 5라고 가정하자.\n이 상황에서 클라이언트로부터 동시에 7개의 요청이 들어온다고 생각해보자.\n클라이언트는 SYN 패킷 7개를 전송하고, 서버의 SYN 큐에 7개의 요청이 쌓인다.\n서버는 클라이언트에게 SYN + ACK 응답을 보낸다.\n그 후 서버는 클라이언트로 총 7개의 ACK를 받아 <code class=\"language-text\">ESTABLISHED</code> 상태가 되어, 7개의 요청을 accept 큐에 넣을 것이다. 그런데 accept 큐의 크기는 5이다.\n따라서 5개의 요청은 큐에 들어가고, 나머지 2개의 요청은 버려진다. 그렇지만 해당 2개의 요청은 이미 <code class=\"language-text\">ESTABLISHED</code> 상태이기 때문에 클라이언트와의 TCP 연결을 끊기 위해 RST 패킷을 전송한다.\n아래 그림3은 요청이 몰렸을 때, 2개의 RST 패킷이 발생하는 상황을 표현한다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 658px; '>\n      <a class='gatsby-resp-image-link' href='/static/29e4866ff56c2985a9d0cd6bca3a1640/e7930/img_2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 102.35294117647058%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC9UlEQVR42q1Uy27TQBTNZ7BhiQRskBAb2CD+gw1igxAfgIT4BRYgJHZFrBCVSim0FPpK0xLUNO4zj8aJ4zzsPGvnYcd2EtuHO06cJn1IrcRIVzPyjM8959w7E7DtKej6dcTjdyDLN2Hb9ylkDIaLyeEMvrrbUJQbODq6hWrlGvr91/SN7dgI2HYC3e5HFItTaDY/Edg0HEe/ANAdAsowzQ+Q5Hdott7Q+fXhlouAf1TTdNpwcJnh2DYsTUO9LKNRr8Pp9UZ7gYEMhwBbxK43lOUSi5M4w9DW0axEEON+IM8vwbFk+MfGGGpXYGihrYooiAeoSAlYhnLC0GfQaDRQqVRQJwmqqsIwDHQ6HW8esRzOrmNCKe/jgFuGkAzCMUsjt0eAx8fHVOk4crkcstksMpkMFapIlZe9uVarecESW1YXhmVDJ5sisRJevo/g7750liH7URRFD4zneaRSKW+dTqe9dT6f99axWAw7u7vY4/7i61oGtx8v4PPv9MUesrlHlWu32x4rQRCQTCaxtbWFcDiMjY0NzM8vILjyCz/DOTx8sYzZ9ez5gDa1hK5TFZtNz1MmmQVjzhj67Hf39hE/4DAXyuLu0yV8WREmJUuShGg06rHJk49MGgNhwTwtFAoeYLVa9ewxTIuq08N8KIVHz2bxLZiaBGTFWFhcRJhkhTY3we3sYJsS8OQd87ZSLsOgqo/3pmmaA+8LeU/VBKBAMlZnZsBzHA4JLHF4SH0mgiemAs1FJpuxpCiTFVKpRPLTaGkGRKmBtm4OPRwCtsmzXqvFzAQ1ItxaFQZlNkimSpLrlLBK4DmKPPMxnkB0O4zvoQzuPZnD9BJ/qij6yV2euG5UJGo8UIcDLKGiwJYlaGtBdOJ7mNvM4cHzNcwExXOqzH5mYP6NYH6denNc/8ZQcztdA3+4NF69XcV65BRDXb/Ea+NOPmedjkHtpaLdUtBsqB6BUVFY3/X7/Us9DuO3y2J2jOWakMya+iqDtY1Pwk8SwH8e/wAyPOPyOHGj3gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='[그림3]RST 패킷 발생' title='' src='/static/29e4866ff56c2985a9d0cd6bca3a1640/e7930/img_2.png' srcset='/static/29e4866ff56c2985a9d0cd6bca3a1640/e7570/img_2.png 170w,\n/static/29e4866ff56c2985a9d0cd6bca3a1640/f46e7/img_2.png 340w,\n/static/29e4866ff56c2985a9d0cd6bca3a1640/e7930/img_2.png 658w' sizes='(max-width: 658px) 100vw, 658px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>[그림3]RST 패킷 발생</figcaption>\n  </figure></p>\n<h2 id=\"문제-해결-및-마무리\" style=\"position:relative;\">문제 해결 및 마무리<a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0-%EB%B0%8F-%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"문제 해결 및 마무리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>지금까지 내용을 정리해보면 <code class=\"language-text\">Connection reset by peer</code> 예외는 클라이언트가 RST 패킷을 수신할 때 발생한다.\n이 RST 패킷은 서버의 accept 큐에 너무 많은 요청이 동시에 도착하여 오버플로우가 발생할 때, 서버가 클라이언트에게 전송하여 소켓 연결을 종료한다.</p>\n<p>이 문제를 해결하기 위해선 listen() 함수의 backlog 값을 조절하거나, 커널 파라미터를 수정할 필요가 있다.\n앞서 살펴본 바와 같이 <strong>min(somaxconn, backlog)</strong> 공식에 따라, somaxconn 값이 backlog보다 작으면 그 값이 적용된다. 따라서 somaxconn 값이 너무 작으면 조정이 필요하다.</p>\n<p>그렇다면 적절한 accept 큐의 크기는 얼마일까? 이는 서버의 환경과 상황에 따라 다르다. 무조건적으로 accept 큐의 크기를 늘린다고 해서 처리량이 그만큼 비례해서 늘어나는 것은 아니다.\n대신, 리눅스에서는 이를 참고할 수 있는 통계를 제공한다.</p>\n<ul>\n<li>TcpExtListenOverflows :  SYN 큐에서 발생하는 오버플로를 추적한다.</li>\n<li>TcpExtListenDrops : accept 큐에서 발생하는 드롭을 추적한다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ sudo apt-get install iproute2\n\n$ nstat -az TcpExtListenDrops\nTcpExtListenDrops 12946172 0.0\n\n$ nstat -az TcpExtListenOverflows\nTcpExtListenOverflows 11447 0.0</code></pre></div>\n<p>또는 netstat의 Recv-Q 로 SYN 큐에 쌓인 요청 수를 알 수도 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">netstat</span> <span class=\"token parameter variable\">-an</span>\nActive Internet connections <span class=\"token punctuation\">(</span>servers and established<span class=\"token punctuation\">)</span>\nProto Recv-Q Send-Q Local Address           Foreign Address         State\ntcp       <span class=\"token number\">20</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:8888            <span class=\"token number\">0.0</span>.0.0:*               LISTEN</code></pre></div>\n<p>이러한 통계를 활용하면 서버의 상황에 맞게 최적의 값을 결정할 수 있다.</p>\n<h2 id=\"더-읽을거리\" style=\"position:relative;\">더 읽을거리<a href=\"#%EB%8D%94-%EC%9D%BD%EC%9D%84%EA%B1%B0%EB%A6%AC\" aria-label=\"더 읽을거리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li><a href=\"https://blog.cloudflare.com/syn-packet-handling-in-the-wild/\">https://blog.cloudflare.com/syn-packet-handling-in-the-wild/</a></li>\n<li><a href=\"https://www.alibabacloud.com/blog/tcp-syn-queue-and-accept-queue-overflow-explained_599203\">https://www.alibabacloud.com/blog/tcp-syn-queue-and-accept-queue-overflow-explained_599203</a></li>\n<li><a href=\"https://brunch.co.kr/@alden/6\">https://brunch.co.kr/@alden/6</a></li>\n</ul>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p><a href=\"https://man7.org/linux/man-pages/man2/accept.2.html\">https://man7.org/linux/man-pages/man2/accept.2.html</a></p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-2\">\n<p>구체적으로 <a href=\"https://elixir.free-electrons.com/linux/v4.14.12/source/include/net/inet_sock.h#L73\">inet_reqeust_sock</a> 을 저장한다.    </p>\n<a href=\"#fnref-2\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-3\">\n<p><a href=\"https://elixir.bootlin.com/linux/v4.15.18/source/Documentation/networking/ip-sysctl.txt#L372\">https://elixir.bootlin.com/linux/v4.15.18/source/Documentation/networking/ip-sysctl.txt#L372</a>    </p>\n<a href=\"#fnref-3\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-4\">\n<p><a href=\"https://man7.org/linux/man-pages/man2/listen.2.html\">https://man7.org/linux/man-pages/man2/listen.2.html</a>    </p>\n<a href=\"#fnref-4\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-5\">\n<p><a href=\"https://elixir.bootlin.com/linux/latest/source/include/net/sock.h#L1033\">https://elixir.bootlin.com/linux/latest/source/include/net/sock.h#L1033</a></p>\n<a href=\"#fnref-5\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-6\">\n<p><a href=\"https://elixir.bootlin.com/linux/latest/source/net/ipv4/tcp_input.c#L6942\">https://elixir.bootlin.com/linux/latest/source/net/ipv4/tcp_input.c#L6942</a></p>\n<a href=\"#fnref-6\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-7\">\n<p><a href=\"https://www.alibabacloud.com/blog/tcp-syn-queue-and-accept-queue-overflow-explained_599203\">https://www.alibabacloud.com/blog/tcp-syn-queue-and-accept-queue-overflow-explained_599203</a></p>\n<a href=\"#fnref-7\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-8\">\n<p><a href=\"https://brunch.co.kr/@alden/6\">https://brunch.co.kr/@alden/6</a></p>\n<a href=\"#fnref-8\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","frontmatter":{"title":"요청이 급증하는 상황의 Connection reset by peer 트러블 슈팅","date":"October 30, 2023","update":"October 30, 2023","tags":["kernel"],"series":null},"fields":{"slug":"/socket_internal/","readingTime":{"minutes":25.695}}},"seriesList":{"edges":[{"node":{"id":"296328f9-f83a-5280-ba4d-bd4de2c4a23a","fields":{"slug":"/ch1/"},"frontmatter":{"title":"1장 - 신뢰할 수 있고 확장 가능하며 유지보수하기 쉬운 애플리케이션"}}},{"node":{"id":"c9052258-da8a-5838-97d0-5affaae34156","fields":{"slug":"/ch2/"},"frontmatter":{"title":"2장 - 데이터 모델과 질의 언어"}}},{"node":{"id":"eaf68b24-edef-59b5-a7f4-4e9ea41b0321","fields":{"slug":"/ch3/"},"frontmatter":{"title":"3장 - 저장소와 검색"}}},{"node":{"id":"522e45a7-12b4-55ae-8295-4a720f58da60","fields":{"slug":"/ch4/"},"frontmatter":{"title":"4장 - 부호화와 발전"}}},{"node":{"id":"5413888c-b834-5d0a-a576-10b33121e612","fields":{"slug":"/ch5/"},"frontmatter":{"title":"5장 - 복제"}}},{"node":{"id":"b7dfee63-516c-5cf7-83bd-cfe07286f825","fields":{"slug":"/ch6/"},"frontmatter":{"title":"6장 - 파티셔닝"}}},{"node":{"id":"a652b497-d0e9-5d72-988a-35fb96da4202","fields":{"slug":"/ch7/"},"frontmatter":{"title":"7장 - 트랜잭션"}}},{"node":{"id":"142b9f9f-7ca6-5376-aa9b-55bd67d46ee3","fields":{"slug":"/ch8/"},"frontmatter":{"title":"8장 - 분산 시스템의 골칫거리"}}},{"node":{"id":"440239bd-9cf3-519f-86af-72f698bb3262","fields":{"slug":"/ch1/"},"frontmatter":{"title":"1부 - 성능 기초"}}},{"node":{"id":"2f0b9a48-2617-5e0a-ab00-4571b7e012c7","fields":{"slug":"/ch2/"},"frontmatter":{"title":"2부 - 성능 개선"}}},{"node":{"id":"60bb268c-033b-5cdd-bba3-9351aa771fb4","fields":{"slug":"/ch3/"},"frontmatter":{"title":"3부 - 화면 응답시간 분석"}}},{"node":{"id":"eee5ea21-1271-510f-9b52-f5c2b8e6f8ed","fields":{"slug":"/ch4/"},"frontmatter":{"title":"4부 - 프로세스 이해하기"}}},{"node":{"id":"e512cc83-75e1-552a-813b-543508957e1f","fields":{"slug":"/ch5/"},"frontmatter":{"title":"5부 - 소스코드 최적화"}}},{"node":{"id":"4db40817-9881-5aea-a6d4-b7b009c1a350","fields":{"slug":"/ch6/"},"frontmatter":{"title":"6부 - SQL 최적화"}}},{"node":{"id":"bb9c36ac-6d3d-53ff-891c-3d0e6d56115a","fields":{"slug":"/ch7/"},"frontmatter":{"title":"7부 - 애플리케이션 입장에서의 SQL 튜닝"}}},{"node":{"id":"15e07ee1-b1da-592c-97db-c67d8a458b0c","fields":{"slug":"/spring-autoconfigure/"},"frontmatter":{"title":"SpringBoot AutoConfiguration 시작하기"}}},{"node":{"id":"00a98f1e-f4b7-562e-b052-7c7bbf333a61","fields":{"slug":"/behavior/"},"frontmatter":{"title":"디자인 패턴 - 행동 패턴"}}},{"node":{"id":"d2b050d0-1ad6-5db3-8087-46c1ef770d5d","fields":{"slug":"/struct/"},"frontmatter":{"title":"디자인 패턴 - 구조 패턴"}}},{"node":{"id":"39f89aa8-d521-51b6-af7e-4f25f0648182","fields":{"slug":"/create/"},"frontmatter":{"title":"디자인 패턴 - 생성 패턴"}}},{"node":{"id":"8934dee6-96ba-552c-bcd6-49294d6e7cc2","fields":{"slug":"/Exactly_Once_Semantics/"},"frontmatter":{"title":"카프카는 어떻게 Exactly-Once Semantics 보장하나?"}}},{"node":{"id":"19fdfd91-656a-5e79-9d96-1f5a12da47ca","fields":{"slug":"/trasaction_in_kafka/"},"frontmatter":{"title":"카프카에서의 Transactions"}}},{"node":{"id":"1e926a5f-341c-585c-a9ef-b00a1e1e4842","fields":{"slug":"/\benabling_exactly_once_kafka_streams/"},"frontmatter":{"title":"카프카 스트림즈의 정확히 한 번"}}},{"node":{"id":"3dcec820-a2a1-54a0-aaf6-fda09480d78d","fields":{"slug":"/Amazon SQS Deep Dive/"},"frontmatter":{"title":"Amazon SQS 딥다이브"}}},{"node":{"id":"4329bf0c-4a54-5d63-9354-7dd221de8490","fields":{"slug":"/Spring Cloud AWS Messaging Module Best Practice/"},"frontmatter":{"title":"Spring Cloud AWS Messaging 모듈 문제점 및 튜닝"}}},{"node":{"id":"b68512de-7b86-5edf-8547-d9e1103dbcf0","fields":{"slug":"/java-collection-wrapper/"},"frontmatter":{"title":"Collection Wrapper 클래스를 이용한 Service 계층 리팩토링 "}}},{"node":{"id":"bdf354b5-bb11-5ca5-b46f-4fe625963602","fields":{"slug":"/spring-cache-hierarchy/"},"frontmatter":{"title":"Spring Cache 로 캐시 계층 구조 사용하기"}}},{"node":{"id":"ca70e5d9-9f49-5e98-be76-85def8989dbf","fields":{"slug":"/redis-event-notifications/"},"frontmatter":{"title":"Redis Keyspace Notifications에 대해 알아보자"}}},{"node":{"id":"f4b0fec2-64a8-50c4-b32f-a4e3165b2c34","fields":{"slug":"/jpa-slow-cause/"},"frontmatter":{"title":"JPA가 느릴 수 밖에 없는 원초적인 이유"}}},{"node":{"id":"258fb9df-ac30-55cf-91f5-1d626b51fbc6","fields":{"slug":"/ehcache3/"},"frontmatter":{"title":"Ehcache3 캐시 라이브러리 소개 (with Spring Boot)"}}},{"node":{"id":"bc1f40bb-26d9-5ce5-8e40-26be0b6f4ec9","fields":{"slug":"/mysql-primary-key-design/"},"frontmatter":{"title":"고성능을 위한 MySQL Primary Key 설계 전략"}}},{"node":{"id":"9edb5e98-0831-5f05-99ac-5243f5e61ed1","fields":{"slug":"/tomcat/"},"frontmatter":{"title":"Apache Tomcat 이해하기(NIO Connector 중심)"}}},{"node":{"id":"be7a2fa8-5b1e-57c0-ac68-164a29e2c50a","fields":{"slug":"/socket_option/"},"frontmatter":{"title":"Java의 Socket Option 정리"}}},{"node":{"id":"380cd3ba-df02-5eb5-bd99-dd88eee889c3","fields":{"slug":"/tomcat-connection/"},"frontmatter":{"title":"Tomcat은 어떻게 Connection을 관리할까?"}}},{"node":{"id":"d3f01e89-0b7e-5518-b223-4f91816fe1fb","fields":{"slug":"/spring-core-container/"},"frontmatter":{"title":"스프링으로 알아보는 IoC 컨테이너의 원리와 이해"}}},{"node":{"id":"74a04ce6-75c4-5373-8a4a-e11360c4778b","fields":{"slug":"/socket_internal/"},"frontmatter":{"title":"요청이 급증하는 상황의 Connection reset by peer 트러블 슈팅"}}},{"node":{"id":"e9743b3d-5c40-582b-ba0f-d58108c30c9a","fields":{"slug":"/mysql-transaction-lock/"},"frontmatter":{"title":"MySQL 잠금과 트랜잭션 Deep Dive"}}},{"node":{"id":"6f0905d8-70e8-531e-b3fa-a1df160991b9","fields":{"slug":"/java-synchronized/"},"frontmatter":{"title":"자바의 synchronized와 volatile"}}}]},"previous":{"fields":{"slug":"/java-nio-selector/"},"frontmatter":{"title":"Java NIO - Selector"}},"next":{"fields":{"slug":"/mysql-transaction-lock/"},"frontmatter":{"title":"MySQL 잠금과 트랜잭션 Deep Dive"}}},"pageContext":{"id":"74a04ce6-75c4-5373-8a4a-e11360c4778b","series":null,"previousPostId":"2f483a49-a913-5333-8509-b98c5a7de019","nextPostId":"e9743b3d-5c40-582b-ba0f-d58108c30c9a"}},"staticQueryHashes":[],"slicesMap":{}}